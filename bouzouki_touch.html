<!DOCTYPE html>
<html lang="he" dir="ltr">
<head>
    <meta charset="UTF-8">
    <title>Bouzouki Touch & Play</title>
    <style>
        body {
            background-color: #121212; color: #e0e0e0;
            font-family: 'Segoe UI', sans-serif; text-align: center;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center; user-select: none; /* ×©×œ× ×™×¡××Ÿ ×˜×§×¡×˜ ×‘×œ×—×™×¦×•×ª */
        }

        h1 { color: #f1c40f; margin-bottom: 5px; }
        p { color: #888; margin-bottom: 20px; }

        /* --- ×¡×¨×’×œ ×¢×œ×™×•×Ÿ --- */
        .top-bar {
            background: #222; padding: 10px 20px; border-radius: 50px;
            display: flex; gap: 20px; align-items: center; margin-bottom: 20px;
            border: 1px solid #444; flex-wrap: wrap; justify-content: center;
        }
        input[type=number] { width: 50px; text-align: center; padding: 5px; border-radius: 5px; border: none; }
        button.btn-small { background: #0984e3; color: white; border: none; padding: 5px 15px; border-radius: 20px; cursor: pointer; }

        /* --- ×”×¦×•×•××¨ --- */
        .scroll-container {
            width: 100%; max-width: 1200px; overflow-x: auto;
            padding-bottom: 10px; margin-bottom: 20px;
            border: 1px solid #222; border-radius: 10px; background: #000;
        }
        .neck {
            position: relative; height: 260px; background-color: #3e2723;
            display: flex; margin: 20px; border: 4px solid #555; border-radius: 8px;
            min-width: 600px;
        }

        /* ××™×ª×¨×™× */
        .string-line { position: absolute; left: 0; width: 100%; pointer-events: none; z-index: 2; }
        .s-re { top: 22%; height: 3px; background: #fff; box-shadow: 0 0 6px white; } 
        .s-la { top: 42%; height: 3px; background: #ccc; }
        .s-fa { top: 62%; height: 4px; background: #a1887f; opacity: 0.9; }
        .s-do { top: 82%; height: 5px; background: #8d6e63; opacity: 0.9; }

        .string-names {
            position: sticky; left: 0; z-index: 100; height: 100%; width: 40px;
            background: #222; border-right: 2px solid #f39c12; color: #f39c12; font-weight: bold;
            display: flex; flex-direction: column; font-size: 14px;
        }
        .s-label { height: 25%; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #333; }

        /* ×¡×¨×™×’×™× */
        .fret {
            flex: 1; min-width: 70px; border-right: 3px solid #bbb; position: relative;
            display: flex; flex-direction: column;
        }
        .fret.is-zero { background: #2b1d19; border-right: 8px solid white; }
        .fret-num { position: absolute; top: -25px; width: 100%; text-align: center; color: #777; font-weight: bold; }
        .inlay-dot {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 15px; height: 15px; background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: none;
        }

        /* === ××–×•×¨×™ ×”×œ×—×™×¦×” ×”×©×§×•×¤×™× (×”×§×¡× ×”×—×“×©) === */
        .click-zone {
            position: absolute; width: 100%; height: 25%; /* ×¨×‘×¢ ×’×•×‘×” ×œ×›×œ ××™×ª×¨ */
            left: 0; cursor: pointer; z-index: 20; /* ××¢×œ ×”××™×ª×¨×™× */
            transition: background 0.1s;
        }
        /* ××™×§×•××™ ××–×•×¨×™ ×œ×—×™×¦×” ×¡×‘×™×‘ ×”××™×ª×¨×™× */
        .cz-0 { top: 10%; } /* ×¡×‘×™×‘ ×¨×” */
        .cz-1 { top: 35%; } /* ×¡×‘×™×‘ ×œ×” */
        .cz-2 { top: 60%; } /* ×¡×‘×™×‘ ×¤×” */
        .cz-3 { top: 85%; } /* ×¡×‘×™×‘ ×“×• (×§×¦×ª ×—×ª×•×š ××‘×œ ×¢×•×‘×“) */
        
        .click-zone:hover { background-color: rgba(255,255,255,0.1); } /* ×”×™×™×œ×™×™×˜ ×‘××¢×‘×¨ ×¢×›×‘×¨ */
        .click-zone:active { background-color: rgba(243, 156, 18, 0.4); } /* ×¤×œ××© ×‘×œ×—×™×¦×” */


        /* ×ª×•×•×™× ×¡×˜×˜×™×™× ×œ××¨××” */
        .static-note {
            position: absolute; width: 100%; text-align: center; font-size: 11px;
            color: rgba(255,255,255,0.15); transform: translateY(-50%); pointer-events: none;
        }
        .pos-0 { top: 22%; } .pos-1 { top: 42%; } .pos-2 { top: 62%; } .pos-3 { top: 82%; }

        /* ×”×¡××Ÿ ×”×¤×¢×™×œ */
        .marker {
            width: 40px; height: 40px; background-color: #e74c3c; border: 3px solid white; border-radius: 50%;
            position: absolute; left: 50%; transform: translate(-50%, -50%); z-index: 50; display: none;
            box-shadow: 0 0 20px #e74c3c; align-items: center; justify-content: center; flex-direction: column;
            font-weight: bold; font-size: 12px; color: white; text-shadow: 1px 1px 0 #000; pointer-events: none;
        }

        /* --- ××–×•×¨ ×ª×—×ª×•×Ÿ --- */
        .editor-panel {
            background: #1f1f1f; padding: 20px; border-radius: 15px; border: 1px solid #444; width: 90%; max-width: 900px;
        }
        
        .controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .btn-act { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; color: white; font-size: 16px; }

        .timeline-wrapper { 
            background: #111; border: 1px dashed #555; padding: 10px; overflow-x: auto; 
            border-radius: 8px; white-space: nowrap; min-height: 80px; display: flex; align-items: center; margin-bottom: 15px;
        }
        
        .note-chip {
            display: inline-block; background: #333; padding: 5px 12px; margin-right: 8px; border-radius: 4px; border-left: 3px solid #f39c12;
            text-align: center; min-width: 50px; cursor: pointer; color: #ddd;
        }
        .note-chip.active { background: #f39c12; color: black; transform: scale(1.1); box-shadow: 0 0 15px #f39c12; }

    </style>
</head>
<body>

    <h1>Bouzouki Touch ğŸ‘†</h1>
    <p>×œ×—×¥ ×™×©×™×¨×•×ª ×¢×œ ×”×’×¨×™×£ ×›×“×™ ×œ× ×’×Ÿ ×•×œ×”×•×¡×™×£ ×ª×•!</p>

    <div class="top-bar" dir="rtl">
        <div>
            ×¡×¨×™×’×™×: <input type="number" id="startFret" value="0" min="0" max="19">
            ×¢×“ <input type="number" id="endFret" value="12" min="0" max="19">
            <button class="btn-small" onclick="updateView()">×”×¦×’</button>
        </div>
        <div>
             ××”×™×¨×•×ª: <input type="range" id="tempoSlider" min="200" max="1500" value="600" style="width:100px; vertical-align:middle;">
        </div>
        <div style="background: #333; padding: 5px 15px; border-radius: 20px; border: 1px solid #555;">
            ×¤×¨×™×˜×” ×”×‘××”: 
            <select id="autoPick" style="background:none; color:#f39c12; border:none; font-weight:bold; font-size:16px;">
                <option value="auto">××•×˜×•××˜×™ (Auto)</option>
                <option value="â¬‡ï¸">×œ××˜×” â¬‡ï¸</option>
                <option value="â¬†ï¸">×œ××¢×œ×” â¬†ï¸</option>
            </select>
        </div>
    </div>

    <div class="scroll-container">
        <div class="neck" id="neckBoard"></div>
    </div>

    <div class="editor-panel">
        
        <div class="controls" dir="rtl">
             <button class="btn-act" style="background:#e74c3c;" onclick="removeLast()">â†©ï¸ ××—×§ ××—×¨×•×Ÿ</button>
             <button class="btn-act" style="background:#c0392b;" onclick="resetMelody()">ğŸ—‘ï¸ × ×§×” ×”×›×œ</button>
             <button class="btn-act" style="background:#2980b9;" onclick="saveTaksim()">ğŸ’¾ ×©××•×¨</button>
             <button class="btn-act" style="background:#8e44ad;" onclick="loadTaksim()">ğŸ“‚ ×˜×¢×Ÿ</button>
        </div>

        <div class="timeline-wrapper" id="timeline" dir="rtl">
            <span style="color:#555; width:100%; text-align:center;">×œ×—×¥ ×¢×œ ×”×’×¨×™×£ ×›×“×™ ×œ×”×ª×—×™×œ...</span>
        </div>

        <button class="btn-act" style="background: #f39c12; color:black; width: 100%; font-size: 24px;" onclick="play()">â–¶ï¸ × ×’×Ÿ ××”×”×ª×—×œ×”</button>
    </div>

    <script>
        const chromaticHE = ["×“×•", "×“×•#", "×¨×”", "××™-×‘", "××™", "×¤×”", "×¤×”#", "×¡×•×œ", "×¡×•×œ#", "×œ×”", "×¡×™-×‘", "×¡×™"];
        const chromaticEN = ["C", "C#", "D", "Eb", "E", "F", "F#", "G", "G#", "A", "Bb", "B"];
        const stringStartNotes = [2, 9, 5, 0]; // D, A, F, C
        const baseFreqC3 = 130.81; 
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // ××©×ª× ×” ×¢×–×¨ ×œ×¤×¨×™×˜×” ××•×˜×•××˜×™×ª
        let lastPick = "â¬†ï¸"; // × ×ª×—×™×œ ×”×¤×•×š ×›×“×™ ×©×”×¨××©×•×Ÿ ×™×”×™×” ×œ××˜×”

        // --- ×ª×¦×•×’×” ---
        let viewStart = 0;
        let viewEnd = 12;

        function updateView() {
            viewStart = parseInt(document.getElementById('startFret').value);
            viewEnd = parseInt(document.getElementById('endFret').value);
            renderNeck();
        }

        function renderNeck() {
            const board = document.getElementById('neckBoard');
            board.innerHTML = ""; 

            // ×©××•×ª
            const names = document.createElement('div'); names.className = 'string-names';
            names.innerHTML = `<div class="s-label">D</div><div class="s-label">A</div><div class="s-label">F</div><div class="s-label">C</div>`;
            board.appendChild(names);

            // ××™×ª×¨×™×
            board.innerHTML += `<div class="string-line s-re"></div><div class="string-line s-la"></div><div class="string-line s-fa"></div><div class="string-line s-do"></div>`;

            // ×¡×¨×™×’×™×
            for (let f = viewStart; f <= viewEnd; f++) {
                const fretDiv = document.createElement('div');
                fretDiv.className = 'fret';
                if(f === 0) fretDiv.classList.add('is-zero');
                fretDiv.id = 'fret-' + f;

                // ××¡×¤×¨
                fretDiv.innerHTML += `<div class="fret-num">${f}</div>`;

                // Inlays
                if ([3, 5, 7, 10, 12, 15, 17, 19].includes(f)) {
                    fretDiv.innerHTML += `<div class="inlay-dot"></div>`;
                }
                if (f === 12) fretDiv.innerHTML += `<div class="inlay-dot" style="top:35%"></div>`;

                // ×™×¦×™×¨×ª ××–×•×¨×™ ×œ×—×™×¦×” + ×ª×•×•×™×
                for (let s = 0; s < 4; s++) {
                    const note = calculateNote(s, f);
                    
                    // ×ª×¦×•×’×” ×¡×˜×˜×™×ª
                    const lbl = document.createElement('div');
                    lbl.className = `static-note pos-${s}`;
                    lbl.innerHTML = `${note.he}<br><span style="color:#f39c12">${note.en}</span>`;
                    fretDiv.appendChild(lbl);

                    // *** ××–×•×¨ ×”×œ×—×™×¦×” ×”×©×§×•×£ ×•×”×—×›× ***
                    const clickZone = document.createElement('div');
                    clickZone.className = `click-zone cz-${s}`;
                    clickZone.title = `${note.he} (${note.en})`; // Tooltip
                    // ×”××™×¨×•×¢ ×”×—×©×•×‘:
                    clickZone.onclick = () => handleFretClick(s, f);
                    fretDiv.appendChild(clickZone);
                }

                // ×¡××Ÿ ××“×•× (××•×¡×ª×¨)
                const marker = document.createElement('div'); marker.className = 'marker'; marker.id = `marker-${f}`;
                fretDiv.appendChild(marker);

                board.appendChild(fretDiv);
            }
        }

        function calculateNote(stringIndex, fretNum) {
            const startNote = stringStartNotes[stringIndex];
            const currentNoteIndex = (startNote + fretNum) % 12;
            return { he: chromaticHE[currentNoteIndex], en: chromaticEN[currentNoteIndex] };
        }

        function getNoteValue(strIdx, fret) {
            const bases = [14, 9, 5, 0]; 
            return bases[strIdx] + fret;
        }

        // --- ××•×“×™×• ---
        function playTone(noteValue) {
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.type = 'sawtooth'; 
            const freq = baseFreqC3 * Math.pow(2, noteValue / 12);
            osc.frequency.value = freq;
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.start();
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.4);
            osc.stop(audioCtx.currentTime + 0.4);
        }

        // --- ×”×œ×‘ ×©×œ ×”××¢×¨×›×ª: ×§×œ×™×§ ×¢×œ ×ª×• ---
        function handleFretClick(str, fret) {
            // 1. ×”×¤×¢×œ×ª ××•×“×™×• (×—×•×‘×” ×§×œ×™×§ ×¨××©×•×Ÿ ×œ×©×—×¨×•×¨ × ×¢×™×œ×” ×‘×“×¤×“×¤× ×™×)
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const soundVal = getNoteValue(str, fret);
            playTone(soundVal);

            // 2. ×—×™×©×•×‘ ×¤×¨×™×˜×”
            const pickMode = document.getElementById('autoPick').value;
            let currentPick = "â¬‡ï¸";
            
            if (pickMode === "auto") {
                currentPick = (lastPick === "â¬‡ï¸") ? "â¬†ï¸" : "â¬‡ï¸";
                lastPick = currentPick;
            } else {
                currentPick = pickMode;
            }

            // 3. ×”×•×¡×¤×” ×œ×¨×©×™××”
            const noteInfo = calculateNote(str, fret);
            melody.push({
                string: str,
                fret: fret,
                pick: currentPick,
                nameHE: noteInfo.he,
                nameEN: noteInfo.en,
                soundVal: soundVal
            });

            // 4. ×¢×“×›×•×Ÿ ×•×™×–×•××œ×™ ××”×™×¨ ×¢×œ ×”×’×¨×™×£ (×¤×œ××© ××“×•×)
            showMarkerBriefly(str, fret, noteInfo);
            
            // 5. ×¢×“×›×•×Ÿ ×”×¨×©×™××”
            renderTimeline();
        }

        function showMarkerBriefly(str, fret, info) {
            const fretDiv = document.getElementById('fret-' + fret);
            if(!fretDiv) return;
            const marker = fretDiv.querySelector('.marker');
            
            // ××™×§×•×
            const topPositions = ["22%", "42%", "62%", "82%"];
            marker.style.top = topPositions[str];
            
            // ×¦×‘×¢
            if(str===0) marker.style.backgroundColor="#e74c3c";
            else if(str===1) marker.style.backgroundColor="#95a5a6";
            else if(str===2) marker.style.backgroundColor="#f39c12";
            else marker.style.backgroundColor="#8d6e63";

            marker.innerHTML = `<div>${info.he}</div>`;
            marker.style.display = 'flex';

            // ×”×¡×ª×¨×” ××—×¨×™ ×—×¦×™ ×©× ×™×” (×¨×§ ×× ×œ× ×× ×’× ×™× ×›×¨×’×¢)
            setTimeout(() => {
                if(!isPlaying) marker.style.display = 'none';
            }, 400);
        }

        // --- × ×™×”×•×œ ×¨×©×™××” ---
        let melody = [];
        let isPlaying = false;

        function removeLast() {
            melody.pop();
            renderTimeline();
            // ××™×¤×•×¡ ×¤×¨×™×˜×” ××—×¨×•× ×” ×¦×¢×“ ××—×•×¨×”
            if (document.getElementById('autoPick').value === "auto") {
                lastPick = (lastPick === "â¬‡ï¸") ? "â¬†ï¸" : "â¬‡ï¸";
            }
        }

        function resetMelody() {
            if(confirm("×‘×˜×•×— ×œ××—×•×§?")) { melody = []; renderTimeline(); }
        }

        function renderTimeline() {
            const el = document.getElementById('timeline');
            el.innerHTML = '';
            if (melody.length === 0) { el.innerHTML = '<span style="color:#555; width:100%; text-align:center;">×œ×—×¥ ×¢×œ ×”×’×¨×™×£...</span>'; return; }

            melody.forEach((note, idx) => {
                const chip = document.createElement('div');
                chip.className = 'note-chip';
                chip.id = 'chip-' + idx;
                chip.innerHTML = `<b>${note.nameHE}</b><br><small>${note.fret}</small><br>${note.pick}`;
                // ×§×œ×™×§ ×¢×œ ×¦'×™×¤ ×× ×’×Ÿ ××•×ª×• ×©×•×‘
                chip.onclick = () => playTone(note.soundVal);
                el.appendChild(chip);
            });
            el.scrollLeft = 0; // ×’×œ×™×œ×” ×œ×©×××œ (×¡×•×£ ×”×¨×©×™××” ×‘-RTL)
        }

        // --- × ×’×Ÿ ---
        function play() {
            if(isPlaying || melody.length === 0) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            isPlaying = true;
            let i = 0;
            const speed = parseInt(document.getElementById('tempoSlider').value);

            const interval = setInterval(() => {
                // × ×™×§×•×™
                document.querySelectorAll('.marker').forEach(m => m.style.display = 'none');
                document.querySelectorAll('.note-chip').forEach(c => c.classList.remove('active'));

                if(i >= melody.length) { clearInterval(interval); isPlaying = false; return; }

                const curr = melody[i];
                playTone(curr.soundVal); // ×¡××•× ×“

                // ×•×™×–×•××œ
                const fretDiv = document.getElementById('fret-' + curr.fret);
                if (fretDiv) {
                    const marker = fretDiv.querySelector('.marker');
                    const topPositions = ["22%", "42%", "62%", "82%"];
                    marker.style.top = topPositions[curr.string];
                    marker.innerHTML = `<div>${curr.nameHE}</div>`;
                    
                    if(curr.string===0) marker.style.backgroundColor="#e74c3c";
                    else if(curr.string===1) marker.style.backgroundColor="#95a5a6";
                    else if(curr.string===2) marker.style.backgroundColor="#f39c12";
                    else marker.style.backgroundColor="#8d6e63";

                    marker.style.display = 'flex';
                    fretDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }

                // ×¡×™××•×Ÿ ×œ××˜×”
                const chip = document.getElementById('chip-' + i);
                if(chip) {
                    chip.classList.add('active');
                    chip.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                }

                i++;
            }, speed);
        }

        // ×©××™×¨×” ×•×˜×¢×™× ×”
        function saveTaksim() { localStorage.setItem("taksimTouch", JSON.stringify(melody)); alert("× ×©××¨!"); }
        function loadTaksim() { 
            const s = localStorage.getItem("taksimTouch"); 
            if(s) { melody = JSON.parse(s); renderTimeline(); alert("× ×˜×¢×Ÿ!"); } 
        }

        // ××ª×—×•×œ
        renderNeck();

    </script>

</body>
</html>