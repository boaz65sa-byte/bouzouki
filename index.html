<!DOCTYPE html>
<html lang="he" dir="ltr">
<head>
    <meta charset="UTF-8">
    <title>Bouzouki Studio V4 (Fixed)</title>
    <style>
        body {
            background-color: #0f0f0f; color: #ecf0f1;
            font-family: 'Segoe UI', system-ui, sans-serif;
            text-align: center; margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center; user-select: none;
        }

        h1 { 
            color: #d4af37; margin-bottom: 5px; 
            text-shadow: 0 2px 15px rgba(212, 175, 55, 0.5); 
            font-weight: 300; letter-spacing: 4px; font-size: 38px;
            font-family: serif;
        }
        .subtitle { color: #888; margin-bottom: 20px; font-size: 14px; letter-spacing: 1px; }

        /* --- ×“×©×‘×•×¨×“ --- */
        .dashboard {
            background: linear-gradient(145deg, #1f1f1f, #252525);
            padding: 15px 25px; border-radius: 20px;
            display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; align-items: center;
            border: 1px solid #444; width: 95%; max-width: 1350px; margin-bottom: 25px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
        }
        
        .control-group {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            padding: 0 12px; border-right: 1px solid #444; min-width: 90px;
        }
        .control-group:last-child { border-right: none; }
        .lbl { font-size: 11px; color: #aaa; font-weight: bold; text-transform: uppercase; }

        select, input[type=number] { 
            background: #000; color: #d4af37; border: 1px solid #555; padding: 6px 10px; border-radius: 6px; 
            text-align: center; font-weight: bold; font-size: 14px; outline: none;
        }

        /* ××™×ª×¨×™× */
        .str-toggles { display: flex; gap: 4px; }
        .str-btn {
            width: 28px; height: 28px; border-radius: 4px; background: #333; color: #666; font-size: 14px;
            display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; border: 1px solid #444;
            transition: 0.2s;
        }
        .str-btn.active { background: #27ae60; color: white; border-color: #2ecc71; box-shadow: 0 0 8px rgba(39, 174, 96, 0.4); }
        .str-btn input { display: none; }

        /* ×›×¤×ª×•×¨ ×¤×œ×™×™ */
        .btn-play {
            width: 50px; height: 50px; border-radius: 50%; border: none; font-size: 22px; cursor: pointer;
            transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
        }
        .btn-play.stopped { background: linear-gradient(145deg, #f1c40f, #d35400); color: black; }
        .btn-play.playing { background: linear-gradient(145deg, #c0392b, #922b21); color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(192, 57, 43, 0); } }

        /* ×›×¤×ª×•×¨×™ ×›×œ×™× */
        .tools-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-tool {
            background: #333; color: #ccc; border: 1px solid #555; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold;
        }
        .btn-tool:hover { background: #444; color: white; border-color: #d4af37; }

        /* --- ×’×¨×™×£ (Elite) --- */
        .scroll-wrapper {
            width: 100%; max-width: 1350px; padding: 10px; margin-bottom: 20px;
            background: #050505; border-radius: 15px; border: 2px solid #333;
            overflow-x: auto; scrollbar-width: thin; scrollbar-color: #555 #111;
        }
        .neck {
            position: relative; height: 280px; display: inline-flex; 
            background-color: #3e2723;
            background-image: repeating-linear-gradient(90deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 1px, transparent 1px, transparent 10px);
            margin: 10px 0; border: 6px solid #222; border-radius: 12px;
            box-shadow: inset 0 0 60px rgba(0,0,0,0.9);
        }

        .string-line { position: absolute; left: 0; width: 100%; pointer-events: none; z-index: 5; transition: 0.3s; opacity: 0.15; }
        .string-line.active { opacity: 1; box-shadow: 0 1px 4px rgba(0,0,0,0.8); }
        .s-re { top: 22%; height: 2px; background: #f0f0f0; } 
        .s-la { top: 42%; height: 3px; background: #ccc; }
        .s-fa { top: 62%; height: 4px; background: #8d6e63; border-bottom: 1px solid #4e342e; } 
        .s-do { top: 82%; height: 5px; background: #5d4037; border-bottom: 1px solid #3e2723; }

        .string-names {
            position: sticky; left: 0; z-index: 100; height: 100%; width: 50px;
            background: #111; border-right: 4px solid #d4af37; color: #d4af37; font-weight: bold;
            display: flex; flex-direction: column; font-size: 16px; font-family: serif;
            box-shadow: 5px 0 20px rgba(0,0,0,0.8);
        }
        .s-label { height: 25%; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #222; }

        .fret {
            flex: 0 0 88px; 
            border-right: 5px solid #bbb; border-image: linear-gradient(to right, #555, #eee, #555) 1;
            position: relative; display: flex; flex-direction: column;
        }
        .fret.is-zero { flex: 0 0 65px; background: #151515; border-right: 12px solid #ecf0f1; border-image: none; }
        .fret-num { position: absolute; top: -30px; width: 100%; text-align: center; color: #666; font-weight: bold; font-family: monospace; }
        .inlay-dot { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 18px; height: 18px; background: radial-gradient(circle at 30% 30%, #fff, #999); border-radius: 50%; pointer-events: none; opacity: 0.9; box-shadow: 0 0 5px black; }

        .static-note {
            position: absolute; width: 100%; text-align: center; font-size: 12px; font-weight: bold;
            color: rgba(255,255,255,0.25); text-shadow: 1px 1px 2px #000;
            transform: translateY(-50%); pointer-events: none; z-index: 4;
        }
        .pos-0 { top: 22%; } .pos-1 { top: 42%; } .pos-2 { top: 62%; } .pos-3 { top: 82%; }

        .marker {
            width: 46px; height: 46px; background: radial-gradient(circle at 30% 30%, #e74c3c, #c0392b);
            border: 2px solid white; border-radius: 50%; position: absolute; left: 50%; transform: translate(-50%, -50%); z-index: 50; 
            display: none; box-shadow: 0 5px 25px rgba(0,0,0,0.9); align-items: center; justify-content: center;
            font-weight: bold; font-size: 12px; color: white; pointer-events: none; text-align: center; text-shadow: 1px 1px 0 #000;
            flex-direction: column; line-height: 1.1;
        }

        .click-zone { position: absolute; width: 100%; height: 25%; left: 0; cursor: pointer; z-index: 20; }
        .cz-0 { top: 10%; } .cz-1 { top: 35%; } .cz-2 { top: 60%; } .cz-3 { top: 85%; }
        .click-zone:hover { background-color: rgba(255,255,255,0.08); }

        /* --- ×ª×—×ª×™×ª --- */
        .bottom-container { width: 95%; max-width: 1300px; display: flex; gap: 20px; flex-wrap: wrap; }
        .editor-panel { flex: 2; background: #1a1a1a; padding: 15px; border-radius: 15px; border-top: 2px solid #333; display: flex; gap: 10px; align-items: center; min-width: 300px; }
        .library-panel { flex: 1; background: #1a1a1a; padding: 15px; border-radius: 15px; border-top: 2px solid #333; min-width: 250px; display: flex; flex-direction: column; gap: 10px; }
        
        .timeline-container { 
            flex-grow: 1; background: #000; border: 1px solid #333; padding: 10px; 
            overflow-x: auto; border-radius: 10px; white-space: nowrap; height: 85px; display: flex; align-items: center;
        }
        .note-chip { 
            display: inline-flex; flex-direction: column; justify-content: center; position: relative;
            background: #333; width: 60px; height: 65px; margin-right: 8px; border-radius: 6px; 
            border-bottom: 3px solid #f39c12; text-align: center; cursor: pointer; color: #ccc; transition: 0.2s; font-size: 12px; flex-shrink: 0;
        }
        .note-chip.active { background: #f39c12; color: black; border-color: white; transform: scale(1.1); }
        .note-chip b { font-size: 14px; color: white; display: block; margin-bottom: 2px; }
        .note-chip.active b { color: black; }

        .btn-act { padding: 8px 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; color: white; font-size: 12px; background: #444; }
        .btn-act:hover { filter: brightness(1.2); }
        .saved-list { background: #000; border: 1px solid #333; border-radius: 8px; height: 150px; overflow-y: auto; padding: 5px; }
        .saved-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #222; color: #aaa; font-size: 14px; cursor: pointer; }
        .saved-item:hover { background: #222; color: white; }
        .saved-name { flex-grow: 1; text-align: right; }
        .del-btn { color: #e74c3c; cursor: pointer; margin-right: 10px; }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
        .modal-content { background-color: #1a1a1a; margin: 8% auto; padding: 30px; border: 2px solid #d4af37; width: 80%; max-width: 700px; border-radius: 20px; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 0 60px rgba(212, 175, 55, 0.2); }
        textarea.tab-area { width: 100%; height: 200px; background: #000; color: #00e676; border: 1px solid #444; padding: 15px; font-family: monospace; font-size: 14px; resize: vertical; border-radius: 8px; }
        .close-modal { color: #aaa; float: right; font-size: 32px; font-weight: bold; cursor: pointer; align-self: flex-end; }
        .btn-modal-action { background: linear-gradient(to bottom, #27ae60, #2ecc71); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }

    </style>
</head>
<body>

    <h1>BOUZOUKI STUDIO <span>V4</span></h1>
    <div class="subtitle">BPM Live â€¢ Fixed Rendering â€¢ Full Library</div>

    <div class="tools-bar">
        <button class="btn-tool" onclick="openModal('tab')">ğŸ“¥ ×™×‘×•× ×˜××‘</button>
        <button class="btn-tool" onclick="openModal('notes')">ğŸ¼ ×™×‘×•× ×ª×•×•×™×</button>
    </div>

    <div class="dashboard" dir="rtl">
        
        <div class="control-group">
            <div class="lbl">××™×ª×¨×™×</div>
            <div class="str-toggles">
                <div class="str-btn active" onclick="toggleStr(0,this)">D<input type="checkbox" id="chk-0" checked onchange="autoUpdate()"></div>
                <div class="str-btn active" onclick="toggleStr(1,this)">A<input type="checkbox" id="chk-1" checked onchange="autoUpdate()"></div>
                <div class="str-btn active" onclick="toggleStr(2,this)">F<input type="checkbox" id="chk-2" checked onchange="autoUpdate()"></div>
                <div class="str-btn active" onclick="toggleStr(3,this)">C<input type="checkbox" id="chk-3" checked onchange="autoUpdate()"></div>
            </div>
        </div>

        <div class="control-group">
            <div class="lbl">×˜×•×•×—</div>
            <div style="display: flex; gap: 3px; align-items: center;">
                <input type="number" id="startFret" value="0" min="0" max="22" onchange="renderNeck()" style="width:45px">
                <span>-</span>
                <input type="number" id="endFret" value="12" min="0" max="22" onchange="renderNeck()" style="width:45px">
            </div>
        </div>

        <div class="control-group">
            <div class="lbl">×©×™×¨×™× ××•×‘× ×™×</div>
            <select id="builtinSongs" onchange="loadBuiltinSong()" style="width: 140px; background:#222;">
                <option value="none">-- ×‘×—×¨ --</option>
                <option value="zorba">×–×•×¨×‘×” ×”×™×•×•× ×™</option>
                <option value="misirlou">××™×¡×™×¨×œ×• (×—×™×’'××–)</option>
                <option value="zeibekiko">×–×‘×§×™×§×• (××™× ×˜×¨×•)</option>
            </select>
        </div>

        <div class="control-group">
             <div class="lbl">BPM</div>
             <input type="range" id="tempoSlider" min="50" max="800" value="300" style="width:70px">
        </div>
        <div class="control-group">
             <button id="playBtn" class="btn-play stopped" onclick="togglePlay()">â–¶</button>
        </div>
    </div>

    <div class="scroll-wrapper">
        <div class="neck" id="neckBoard"></div>
    </div>

    <div class="bottom-container">
        <div class="editor-panel">
            <div class="actions">
                <button class="btn-act" style="background:#e74c3c" onclick="removeLast()">â†© ××—×§</button>
                <button class="btn-act" style="background:#c0392b" onclick="resetMelody()">ğŸ—‘ × ×§×”</button>
            </div>
            <div class="timeline-container" id="timeline" dir="rtl">
                <span style="color:#444; width:100%; text-align:center; font-size:14px;">×”×˜×™×™××œ×™×™×Ÿ ×¨×™×§...</span>
            </div>
        </div>

        <div class="library-panel" dir="rtl">
            <div class="lbl" style="text-align:right">ğŸ“‚ ×¡×¤×¨×™×™×”</div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="saveName" placeholder="×©×..." style="text-align:right; width:120px;">
                <button class="btn-act" style="background:#27ae60" onclick="saveSong()">×©××•×¨</button>
            </div>
            <div class="saved-list" id="savedList"></div>
        </div>
    </div>

    <div id="modalTab" class="modal">
        <div class="modal-content" dir="rtl">
            <span class="close-modal" onclick="closeModal('tab')">&times;</span>
            <h2 style="color:#d4af37; margin:0;">×™×‘×•× ×˜××‘</h2>
            <textarea id="inputTab" class="tab-area" placeholder="D---5--5--..."></textarea>
            <button class="btn-modal-action" onclick="parseTab()">×ª×¨×’× ×œ× ×’×™× ×”</button>
        </div>
    </div>

    <div id="modalNotes" class="modal">
        <div class="modal-content" dir="rtl">
            <span class="close-modal" onclick="closeModal('notes')">&times;</span>
            <h2 style="color:#d4af37; margin:0;">×™×‘×•× ×ª×•×•×™× (ABC)</h2>
            <textarea id="inputNotes" class="tab-area" placeholder="C D E F G A B"></textarea>
            <button class="btn-modal-action" onclick="parseNotes()">×ª×¨×’× ×œ× ×’×™× ×”</button>
        </div>
    </div>

    <script>
        const chromaticHE = ["×“×•", "×“×•#", "×¨×”", "××™-×‘", "××™", "×¤×”", "×¤×”#", "×¡×•×œ", "×¡×•×œ#", "×œ×”", "×¡×™-×‘", "×¡×™"];
        const chromaticEN = ["C", "C#", "D", "Eb", "E", "F", "F#", "G", "G#", "A", "Bb", "B"];
        const stringStartNotes = [2, 9, 5, 0]; 
        const stringBaseVals = [14, 9, 5, 0];

        // ×ª×•×§× ×• ×”×˜××‘×™× ×œ×©×¤×” ×©×”××¢×¨×›×ª ××›×™×¨×” (D A F C)
        const songsDB = {
            'zorba': "D2 D3 D2 D3 D2 A0 A1 A2 A3 A4 A5 D2 D3 D4 D5", // Zorba Intro
            'misirlou': "D0 D1 D4 D5 D7 D8 D11 D8 D7 D5 D4 D1 D0",
            'zeibekiko': "A0 A2 A3 A2 A0 F2 F4 F5 F4 F2 C0 C2 C4"
        };

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let melody = [];
        let isPlaying = false;
        let playTimeout = null; 
        let currentNoteIndex = 0;
        let library = JSON.parse(localStorage.getItem('bouzouki_elite_lib') || '{}');

        function init() { refreshLib(); renderNeck(); }

        // --- Core ---
        function toggleStr(idx, el) {
            el.classList.toggle('active');
            document.getElementById('chk-'+idx).checked = el.classList.contains('active');
            autoUpdate();
        }
        function autoUpdate() { renderNeck(); }

        // --- Import Logic ---
        function openModal(type) { document.getElementById(type==='tab'?'modalTab':'modalNotes').style.display = 'block'; }
        function closeModal(type) { document.getElementById(type==='tab'?'modalTab':'modalNotes').style.display = 'none'; }
        
        // ×ª×™×§×•×Ÿ: ×¤×•× ×§×¦×™×™×ª "××•×˜×•-×–×•×" ×œ×”×‘×˜×—×ª ×”×¦×’×ª ×ª×•×•×™×
        function ensureRangeForMelody() {
            // ××’×“×™×¨ ××•×˜×•××˜×™×ª ×˜×•×•×— 0-22 ×›×“×™ ×©×›×œ ×”×ª×•×•×™× ×™×•×¦×’×•
            document.getElementById('startFret').value = 0;
            document.getElementById('endFret').value = 22;
            renderNeck();
        }

        function parseTab() {
            const text = document.getElementById('inputTab').value;
            if(!text.trim()) return;
            resetMelody();
            
            const lines = text.split('\n');
            let tracks = { D: "", A: "", F: "", C: "" };
            let hasComplex = false;
            lines.forEach(line => {
                let l = line.trim();
                if(l.toUpperCase().startsWith("D")) { tracks.D += l.substring(1); hasComplex=true; }
                else if(l.toUpperCase().startsWith("A")) tracks.A += l.substring(1);
                else if(l.toUpperCase().startsWith("F")) tracks.F += l.substring(1);
                else if(l.toUpperCase().startsWith("C")) tracks.C += l.substring(1);
            });

            if(!hasComplex) {
                const regex = /([DAFC])\s*[-]*\s*(\d+)/gi;
                [...text.matchAll(regex)].forEach(m => {
                    let s = (m[1].toUpperCase()==='D')?0:(m[1].toUpperCase()==='A')?1:(m[1].toUpperCase()==='F')?2:3;
                    let f = parseInt(m[2]);
                    if(f>=0 && f<=22) addNote(s, f);
                });
            } else {
                const maxLen = Math.max(tracks.D.length, tracks.A.length, tracks.F.length, tracks.C.length);
                for(let i=0; i<maxLen; i++) {
                    checkChar(0, tracks.D[i]); checkChar(1, tracks.A[i]); checkChar(2, tracks.F[i]); checkChar(3, tracks.C[i]);
                }
            }
            ensureRangeForMelody(); // ×”×ª×™×§×•×Ÿ ×”×§×¨×™×˜×™
            renderTimeline(); closeModal('tab');
            if(melody.length>0) togglePlay();
        }

        function checkChar(strIdx, char) {
            if(!char) return;
            if(!isNaN(parseInt(char))) {
                addNote(strIdx, parseInt(char));
            }
        }

        function parseNotes() {
            const text = document.getElementById('inputNotes').value.trim();
            if(!text) return; resetMelody();
            
            const tokens = text.replace(/,/g, ' ').split(/\s+/);
            const notesMap = { 'C':0, 'C#':1, 'D':2, 'D#':3, 'E':4, 'F':5, 'F#':6, 'G':7, 'G#':8, 'A':9, 'A#':10, 'B':11 };

            tokens.forEach(token => {
                let cleanToken = token.toUpperCase().replace(/[0-9'"]/g, '').replace('â™¯','#').replace('â™­','B');
                let basePitch = notesMap[cleanToken];
                if (basePitch !== undefined) {
                    let isHigh = (token[0] === token[0].toLowerCase());
                    let targetVal = basePitch + (isHigh ? 12 : 0);
                    let found = false;
                    let stringOrder = isHigh ? [0, 1, 2, 3] : [3, 2, 1, 0];
                    for (let s of stringOrder) {
                        let sBase = stringBaseVals[s];
                        let fret = targetVal - sBase;
                        if (fret < 0) fret += 12; 
                        if (fret >= 0 && fret <= 22) { addNote(s, fret); found = true; break; }
                    }
                    if (!found) { // Fallback
                        for (let s of [0, 1]) { 
                             let fret = (targetVal + 12) - stringBaseVals[s];
                             if (fret >= 0 && fret <= 22) { addNote(s, fret); break; }
                        }
                    }
                }
            });
            ensureRangeForMelody(); // ×”×ª×™×§×•×Ÿ ×”×§×¨×™×˜×™
            renderTimeline(); closeModal('notes');
            if(melody.length > 0) togglePlay();
        }

        function loadBuiltinSong() {
            const key = document.getElementById('builtinSongs').value;
            if(key==='none') return;
            document.getElementById('inputTab').value = songsDB[key];
            parseTab();
        }

        // --- Render ---
        function renderNeck() {
            const startF = parseInt(document.getElementById('startFret').value);
            const endF = parseInt(document.getElementById('endFret').value);
            const activeStrings = [
                document.getElementById('chk-0').checked, document.getElementById('chk-1').checked,
                document.getElementById('chk-2').checked, document.getElementById('chk-3').checked
            ];

            const board = document.getElementById('neckBoard'); board.innerHTML = ""; 
            board.innerHTML += `<div class="string-names"><div class="s-label">D</div><div class="s-label">A</div><div class="s-label">F</div><div class="s-label">C</div></div>`;
            ['s-re','s-la','s-fa','s-do'].forEach((c,i)=>{
                board.innerHTML += `<div class="string-line ${c} ${activeStrings[i]?'active':''}"></div>`;
            });

            for (let f = startF; f <= endF; f++) {
                const div = document.createElement('div'); div.className = 'fret ' + (f===0?'is-zero':'');
                div.id = 'fret-'+f;
                div.innerHTML += `<div class="fret-num">${f}</div>`;
                if([3,5,7,10,12,15,17,19,21].includes(f)) div.innerHTML += `<div class="inlay-dot" ${f===12?'style="top:35%"':''}></div>`;

                for(let s=0; s<4; s++) {
                    const n = calculateNote(s,f);
                    const lbl = document.createElement('div'); lbl.className = `static-note pos-${s}`;
                    lbl.innerHTML = `${n.he}<br>${n.en}`;
                    div.appendChild(lbl);

                    const zone = document.createElement('div'); zone.className = `click-zone cz-${s}`;
                    zone.onclick = () => handleFretClick(s, f);
                    div.appendChild(zone);
                }
                const m = document.createElement('div'); m.className = 'marker'; m.id = `m-${f}`;
                div.appendChild(m);
                board.appendChild(div);
            }
        }

        function handleFretClick(s, f) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            addNote(s, f);
            playTone(getNoteValue(s,f));
            
            // ×ª×¦×•×’×ª ××¨×§×¨ ×™×“× ×™×ª
            const m = document.getElementById(`m-${f}`);
            if(m) {
                const tops = ["22%","42%","62%","82%"];
                m.style.top = tops[s]; m.style.display = 'flex'; m.style.backgroundColor="#e74c3c";
                const info = calculateNote(s, f);
                m.innerHTML = `<div>${info.he}</div>`;
                setTimeout(() => { if(!isPlaying) m.style.display = 'none'; }, 400);
            }
            renderTimeline();
        }

        // --- Helpers ---
        function calculateNote(s, f) {
            const idx = (stringStartNotes[s] + f) % 12;
            return { he: chromaticHE[idx], en: chromaticEN[idx] };
        }
        function getNoteValue(s, f) { return stringBaseVals[s] + f; }

        function playTone(val) {
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.value = 130.81 * Math.pow(2, val / 12);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.35);
            osc.stop(audioCtx.currentTime + 0.35);
        }

        function addNote(s, f) {
            const info = calculateNote(s, f);
            let val = getNoteValue(s, f);
            melody.push({ s:s, f:f, nameHE: info.he, nameEN: info.en, soundVal: val });
        }

        function removeLast() { stop(); melody.pop(); renderTimeline(); }
        function resetMelody() { stop(); melody=[]; renderTimeline(); }

        function renderTimeline() {
            const tl = document.getElementById('timeline'); tl.innerHTML = "";
            if (melody.length === 0) { tl.innerHTML = '<span style="color:#555; width:100%; text-align:center;">×”×˜×™×™××œ×™×™×Ÿ ×¨×™×§...</span>'; return; }
            melody.forEach((n, i) => {
                const c = document.createElement('div'); c.className = `note-chip`; c.id = 'chip-'+i;
                c.innerHTML = `<b>${n.nameHE}</b><small>${n.nameEN}</small>`;
                c.onclick = () => playTone(n.soundVal);
                tl.appendChild(c);
            });
            tl.scrollLeft = 0;
        }

        // --- BPM Logic (Fixed) ---
        function togglePlay() { if(isPlaying) stop(); else play(); }
        function play() {
            if(melody.length===0) return;
            if(audioCtx.state==='suspended') audioCtx.resume();
            isPlaying = true;
            document.getElementById('playBtn').innerText = "â¹";
            document.getElementById('playBtn').className = "btn-play playing";
            currentNoteIndex = 0;
            playStep();
        }
        function playStep() {
            if(!isPlaying) return;
            if(currentNoteIndex >= melody.length) { stop(); return; }
            document.querySelectorAll('.marker').forEach(e=>e.style.display='none');
            document.querySelectorAll('.note-chip').forEach(e=>e.classList.remove('active'));
            
            const curr = melody[currentNoteIndex];
            
            // ×× ×’×Ÿ ×¡××•× ×“
            playTone(curr.soundVal);
            
            // ××¦×™×’ ×•×™×–×•××œ×™×ª (×—×©×•×‘: ×‘×•×“×§ ×©×”××¨×§×¨ ×§×™×™×)
            const m = document.getElementById(`m-${curr.f}`);
            if(m) {
                const tops = ["22%","42%","62%","82%"];
                m.style.top = tops[curr.s]; m.style.backgroundColor = "#e74c3c";
                m.innerHTML = `<div>${curr.nameHE}</div>`;
                m.style.display = 'flex';
                // ×’×œ×™×œ×” ×œ×’×¨×™×£
                m.parentElement.scrollIntoView({behavior:'smooth', inline:'center'});
            }

            // ×’×œ×™×œ×” ×œ×˜×™×™××œ×™×™×Ÿ
            const chip = document.getElementById('chip-'+currentNoteIndex);
            if(chip) { chip.classList.add('active'); chip.scrollIntoView({behavior:'smooth', inline:'center'}); }
            
            currentNoteIndex++;
            const delay = document.getElementById('tempoSlider').value;
            playTimeout = setTimeout(playStep, delay);
        }
        function stop() {
            isPlaying = false; clearTimeout(playTimeout);
            document.getElementById('playBtn').innerText = "â–¶";
            document.getElementById('playBtn').className = "btn-play stopped";
            document.querySelectorAll('.marker').forEach(e=>e.style.display='none');
            document.querySelectorAll('.note-chip').forEach(e=>e.classList.remove('active'));
        }

        // --- Library ---
        function refreshLib() {
            const div = document.getElementById('savedList'); div.innerHTML = "";
            Object.keys(library).forEach(k => {
                div.innerHTML += `<div class="saved-item"><span class="del-btn" onclick="delSong('${k}')">âœ–</span><span class="saved-name" onclick="loadSong('${k}')">${k}</span></div>`;
            });
        }
        function saveSong() {
            const n = document.getElementById('saveName').value;
            if(n && melody.length>0) { library[n]=melody; localStorage.setItem('bouzouki_elite_lib',JSON.stringify(library)); refreshLib(); }
        }
        function loadSong(k) {
            stop();
            if(confirm("×œ×˜×¢×•×Ÿ ××ª " + k + "?")) { 
                melody = library[k]; 
                ensureRangeForMelody();
                renderTimeline(); 
            }
        }
        function delSong(k) { if(confirm("×œ××—×•×§?")) { delete library[k]; localStorage.setItem('bouzouki_elite_lib', JSON.stringify(library)); refreshLib(); } }

        init();
    </script>

</body>
</html>
